# Car Wash Daily Check â€” Cron Setup

## Overview

Every vehicle gets a **10-day car wash reminder** sent to its assigned driver.
The reminder is generated by calling the Supabase function `check_car_wash_due()` once per day.

## Database Function

```sql
-- Already created in Supabase (project: vdsknsypobnutnqcafre)
SELECT check_car_wash_due();
```

Logic:
1. Loop through all `active` vehicles that have an `assigned_driver_id`
2. For each vehicle, look up the most recent `wash_date` from `vehicle_car_washes`
3. If days since last wash â‰¥ 10 (or never washed), insert a `car_wash_due` notification
4. Deduplication: only inserts if no unread notification exists for that vehicle in the past 24h

## OpenClaw Cron Setup

Jarvis sets up a daily cron job at **6:00 AM MST** to call this function.

```typescript
// How to trigger from Node/TypeScript:
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // Use service role for cron calls
);

await supabase.rpc('check_car_wash_due');
```

## OpenClaw Cron Command

```bash
# To set up via OpenClaw CLI:
openclaw cron add "car-wash-check" "0 13 * * *" \
  "node -e \"require('@supabase/supabase-js').createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY).rpc('check_car_wash_due')\""
```

> Note: `0 13 * * *` = 6:00 AM MST (UTC-7), i.e., 13:00 UTC

## Notification Flow

```
Daily at 6 AM
     â”‚
     â–¼
check_car_wash_due() runs in Supabase
     â”‚
     â”œâ”€â”€ Vehicle has assigned_driver_id?
     â”‚       YES â†’ days since last wash â‰¥ 10?
     â”‚               YES â†’ insert driver_notifications row
     â”‚               NO  â†’ skip
     â”‚       NO  â†’ TODO: notify dispatcher (future enhancement)
     â”‚
     â–¼
Supabase Realtime fires INSERT event
     â”‚
     â–¼
Driver App (useNotifications hook) receives push via postgres_changes
     â”‚
     â–¼
Notification badge appears on "Alerts" tab
Driver sees: "ðŸš¿ Car Wash Due â€” [Vehicle Name]"
Driver taps "Log Car Wash" â†’ inserts vehicle_car_washes record â†’ resets clock
```

## Tables Involved

| Table | Purpose |
|-------|---------|
| `vehicles` | Source of active vehicles + `assigned_driver_id` |
| `vehicle_car_washes` | Log of all car washes (tracks last wash date) |
| `driver_notifications` | In-app notifications delivered to drivers |

## Reset Flow

When a driver logs a car wash via the app:
1. `vehicle_car_washes.insert({ vehicle_id, driver_id, wash_date: today })`
2. Notification is marked `read = true`
3. Next `check_car_wash_due()` run will skip this vehicle (days_since = 0)

## Status

- [x] `driver_notifications` table created
- [x] `check_car_wash_due()` function created  
- [x] `assigned_driver_id` column added to `vehicles`
- [x] Driver App: `useNotifications` hook
- [x] Driver App: Notifications screen
- [x] Driver App: Bell badge in tab bar
- [ ] OpenClaw cron: pending setup by Jarvis
